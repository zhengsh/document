# 数据库系统

* **数据库模式**
* ER模型
* **关系代数**
* 元组演算
* **规范化理论** 
* 并发控制
* 数据库完整性约束
* 分布式数据库
* 数据仓库与数据挖掘
 
### 三级模式-两层映射
  是典型的**分层架构**

* 用户级数据库
* 用户视图
* 概念级数据库
* DBA视图
* 物理数据库
* 内部视图

* 视图 （外模式）【应用程序 => 视图 => 基本表】

  * 数据库视图
    它使一个虚拟表（逻辑上的表），其内容由查询定义（**仅保存SQl查询语句**）同真实的表一样，
    视图包含一系列带有名称的列和行数据，但是，视图并没有真正存储这些数据，
    而是通过查询原始表动态生成所需要的数据。
    
  * 视图的优点
    * **视图能简化用户操作（多表关联查询结果）**
    * 视图使用户能以多重角度看待同一数据
    * **视图对重构数据库提供了一定程度的逻辑独立性**
    * 视图可以对机密数据提供安全保护
    
  * 物化视图
    * 他不是传统意义上的视图，是实体化视图，其本身会存储数据。同事当原始表中的数据更新时，物化视图也会更新。
    **更新原始表，效率会降低**
    
* 基本表 （概念模式）
* 物理文件（内模式）

* 总结：
  * 1、外模式,
外模式也成为子模式或用户模式，对应用户级数据库。外模式用来描述用户看到或者使用那部分数据的逻辑结构，是数据库用户的数据视图，是与某一应用有关的数据的逻辑表示。用户根据外模式用数据操作语句或应用程序去操作数据库中的数据。
  * 2、概念模式
概念模式也成为模式或者逻辑模式，对应概念级数据库，概念模式是数据库中全体数据的逻辑结构和特征的描述，是所有用保护的共同数据视图，用以描述现实世界中的实体以及其性质和联系，定义记录、数据项、数据的完整性约束条件以记录之间的联系。
  * 3、内模式
内模式对应物理级数据库，是数据物理结构和存储方式的描述，是数据在数据库内部的表示方式。内模式不同于物理层，它架设外存是一个无限的线性地址空间。内模式定义是存储记录的类型、存储域的表示和存储记录的物理顺序，以及缩影和存储路径等的存储组织。数据库结构设计的不同阶段、概念设计、逻辑设计和物理设计。
    * 1）、概念设计也称为概念结构设计，其任务是在需求分析阶段产生的需求说明书的基础上，按照特定的方法将他们抽象为一个不依赖与任何DBMS的数据模型，即概念模型。在进行概念设计时，可以先设计各个应用的视图。即各个应用所看到的的数据及其结构，然后在惊醒视图集成，以形成一个单一的概念数据模型，一般就用E-R图表示。
    * 2）、逻辑设计也称为逻辑结构设计，其任务是将概念模型转化为某特定的DBMS上的罗模型。逻辑设计的目的是将概念设计阶段的E-R图转换为援用的具体机器上的DBMS所支持的数据模型相符合的逻辑结构。
    * 3）、物理设计也称为物理结构设计，其任务是对戈丁的逻辑模型选取一个最合适应用环境的物理结构，所谓数据库的物理结构，主要是指数据库在物理设备上的存储结构和存取方法。


目标：数据库变化，不带来应用程序的变化（**两级映射**）
 
**考点：
   外模式（视图）、概念模式（基本表）、内模式（物理文件）
   修改 外模式-概念模式映射 可以做到修改基本表应用程序不变
   视图（外模式 -> 模式） 基本表 （模式 -> 内模式）**

 
### 数据库设计过程
* 需求分析（**概念结构设计的依据**）
  * 数据流图 （DFD）
  * 数据字典（DD）
  * 需求说明书（SRS）
  
* 概念结构设计
  * ER模型，（实体、联系、属性）
  
* 逻辑结构设计
  * 关系模式
  
* 物理设计

* **和软件工程设计过程对比** 
和软件工程中的说法有冲突
  在软件工程中，ER模型，是需求分析阶段的数据建模工具
  数据库中，ER模式是概念结构设计的产物

### ER模型
* 需求分析
* 概念结构设计
  * 抽象数据
  * 设计局部的ER模型
  * 合并局部模型，消除冲突
  * 重构优化、消除冗余
* 逻辑设计

* **如何将ER模型转换为关系模式**
  * 每个实体要单独转换为一个关系模式
  * 转换时，每个属性，就是一个字段
  如： 学生（学号，姓名，性别，年龄）
  

* **一个实体转换为一个单独的关系模式**
  * 1:1 联系
  * 1:n 联系
    可以单独转，也可以吧联系与N端合并
  * m:n 联系
    必须单独转关系模式
  
### 关系代数
* 并
* 交 
* 差 （结果，在S1中，但不在S2中的记录）
  A-B =（a, b）
* 笛卡尔积
  * S1和S2 属性 = S1属性 与 S2属性
  * 结果集的记录数=S1记录数 * S2记录数
* 投影
  * 获取列
* 选择
  * 满足条件的记录（行）
    筛选（查询符合条件的）行
* 连接
  * 自然连接
    * 对S1 与S2 的相同属性（相同列），做等值连。
    * 去掉重复属性。  

### 规范化理论
* 价值和用途
  * 非规范化的关系模式，可能存在的问题包括：数据冗余，更新异常，插入异常，删除异常。
* 函数依赖
  设R(U)是属性U上的一个关系模式，X和Y是U的子集，r为R的任一关系，如果对于r中的任意两个元祖u,v,只要有
  u[X]=u[Y],则称X函数决定Y,或称Y函数依赖于X,记为X-Y
关系模式：R(A, B, C )
**部分函数依赖**
依赖集1: (AB -> D, A -> C)
就是说一个属性依赖于主键的一部分，AB的组合键是主键，A -> C. 所以C对关系模式存在部分函数依赖

**传递函数依赖**
依赖集2：(A->B, B->C)


* 键
  * 候选键，（唯一标识元祖（记录），且无冗余） 入度为0
  * 主键， （多个候选键中选一个）
  * 外键 （其他关系的主键）

* 候选键的
总结：
 1、入度为0 的键，是候选键 （如果他不能被选择则他就成了 信息孤岛）
 2、即有入度，也有出度的节点

* 数据库范式
  插入异常、删除异常、数据冗余
  逐步优化、以解决
  * 1NF 属性都是不可分的原子值
  * 2NF 消除非属性对候选键的部分依赖
    第二范式（2NF）：当且仅当实体E是第一范式（1NF），且每一个**非主属性完全依赖主键**(不存在部分依赖)时
则称实体E是第二范式。
  * 3NF 消除非主属性对候选键的传依赖
    第三范式（3NF）：当且仅当实体E是第二范式（1NF），且E中没有**非主属性传递依赖**于码，则称实体E是第三范式
  * BCNF消除主属性对候选键的部分和传递依赖
    BC 范式（BCNF）：
      设R是一个关系模式，F是他的依赖集，
    R属于BCNF当且仅当其F中每个依赖的决定因素必定包含R的某个候选码。
    
* 无损分解
  * 保持函数依赖分解
     设数据库模式p={R1, R2,...,Rk}是关系模式R的一个分解，F是R上的函数依赖集，p 中每个模式Ri上的 FD集是Fi。
     如果{F1, F2，...,Rk}与F是等价的(即相互逻辑蕴含)， 那么称分解p 保持FD
  * 无损分解
    什么是有损，什么是无损？
    有损：不能还原， 无损，可以还原
   无损连接分解：指将一个关系模式分解成若干个关系模式后，通过自然连接和投影灯运算仍能还原到原来的关系模式。
    例子：
    压缩
    无损压缩 压缩后可以还原
    把word 压缩成zip
    
    有损压缩 如JPG
    原始图片，压缩成jpg之后无法还原
    
  * 表格法
    **总结：表格分解, 如果一行全是钩钩，说明就是无损分解**
  * 公式法
    适用于一分为二的场景
  
  * 推理规则
    * A1, 自反律

### 反规范化（考点：反规范化、分布式数据库等）
  由于规范化，会使得表不断的拆分，从而导致数据表过多，这样虽然较少了数据库的冗余，提高了增、删、改的速度但会增加查询的工作量。
系统需要进行多次连接才能进行查询操作，使得系统的效率大大的下降。
  * 技术手段
    * 增加派生性冗余列
      出生年月->年龄
      单价，数量->总额
    * 增加冗余列
      成绩表中有 学号，增加冗余列 姓名
    * 重新组表
    * 分割法
 
 ### 并发控制
  * 事务 （ACID）
    * 原子性
    * 一致性
    * 隔离性
    * 持续性

  * 并发产生的问题
    * 丢失更新
    * 不可重复读
    * "脏"数据的读出
  * 封锁协议
    * S封锁
    * X封锁
    * 一级封锁协议
    * 二级封锁协议
    * 三级封锁协议
    * 两段锁协议
  * 死锁
    * 预防
    * 死锁的解除
    
### 数据库完整性约束
  * 实体完整性约束
    主键的设定，唯一，非空
  * 参照完整性约束
    外键关系，外检要能查到，或为空
  * 用户自定义完整性约束
    年龄 0-150
  * 触发器 
  
### 数据备份
  * 冷备份也称为静态备份，是将数据库苦关闭正常关闭，在停止状态下，将书库的文件全部备份（复制下来）。
  * 热备份也称为动态备份，利用动态备份软件，在数据库正常的运行状态下，降数据库中的数据文件备份出来。
  优缺点对比
  冷备份
    优点：
      非常快速的备份方法（只需要复制文件）；容易归档（简单复制即可）；容易恢复到某个时间点上（只需将文件再复制回去）
    能在归档方法相结合，做数据库"最佳状态"的恢复，低度维护，高度安全。
    缺点：
      单独使用时，只能提供到某个时间点上的恢复，在实施备份的全过程中，数据库必须要作备份而不能做其他工作，
    若磁盘空间有限只能复制到磁带等外部存储设备上，速度会很慢，不能按表或用户恢复
  热备份
    优点：
      可在表空间或数据库文件级备份， 备份的时间短；备份时数据库仍可使用，可达到秒级恢复（到某一时间点上）；
    可对几乎所有的数据实体做恢复；恢复是快速的
    缺点：
      不能出错，否则后果严重；若备份不成功，所得结果不可用于时间的恢复，因难与维护，所以要特别消息，不允许"以失败告终"
      
  * 完全备份：备份所有数据
  * 差量备份：仅备份上一次完全备份之后变化的数据
  * 增量备份：备份上一次备份后变化后的数据
  
  * 日志文件：事物日志是针对数据库所改变所做的记录，它可以记录针对数据库的任何操作，并记录结果保存在独立的文件中

### 数据库故障与恢复

故障关系：
* 事务本身不可预期的故障，系统自动完成恢复。
* 软故障（系统故障）通常使用检查点的方法来恢复。

### 分布式数据库
  一个数据库的内容存储到不同的节点上去
  分片：逻辑结构
  分库：物理结构
  
  * 概念
    * 分布透明
      * 分片透明性
          水平分片
          垂直分片
          混合分片
        
    * 分布式数据库管理统一组成
    
    * 分布式数据管理系统结构
  
  * 数据表分区
    表分区：就是讲一个数据量比较大的表，用某种方法把数据从物理上分成若干个小表来存储从逻辑上来看还是一个大表
    
    * 分区与分表的区别与联系
    
  
  * 联邦数据库
    * 特征
      * 分布性
      * 异构性
      * 自治性
      * 透明性
  
### NoSQL
  NoSQL（Not-only SQL）:泛指非关系型数据库。
  关系型书库的缺陷："高并发读写的性能低，支持容量有限、数据库的可拓展性和可用性低、建设和运维成本高"
  
  关系数据库模式 
   支持并发、效率低
   关系表方式存储、SQL查询
   向上拓展
     单台服务器，升级时，升级为性能更高的，单台服务器，原来的服务器淘汰。
   B树、哈希等
   面向通用领域
   
  NoSQL 模式
    并发性能高
    海量数据存储、查询效率高
    向外拓展
      集群，通过增加服务器来解决问题。
    健值索引
    特定应用领域
      
  * 分类
    * 键值存储
    * 列存储数据库
    * 文档型数据库
    * 图形数据库（Graph）

### 内存数据库
  

### 大数据
  * 4V
    * 数据量（Volume）
    * 速度（Velocity）
    * 多样性（Variety）
    * 值（Value）
    

### 总结
* 脏数据，是在ROLLBACK 之前读取
* 双代号网络，虚线代表虚活动，既不占时间，也不占资源，但是必不可少
* 关系模式不能被拆分，就可以达到所有的范式
* 无损连接和函数依赖，
  * 无损分解的：拆分后表格能否还原
  * 函数依赖的保持是：拆分后数据之间的关系是否丢失
  
  