# Kubernetes 高可用集群

## 概述

在之前的操作中 Kubernetes 是**集群模式**，但是在实际生产中，我们需要部署**高可用集群**，本章内容旨在完成 Kubernetes 高可用集群。

## 统一环境配置

### 节点配置

| 主机名               | IP            | 角色   | 系统              | CPU/内存 | 磁盘 |
| -------------------- | ------------- | ------ | ----------------- | -------- | ---- |
| kubernetes-master-01 | 192.168.1.100 | Master | CentOS Server 7.7 | 2核2G    | 80G  |
| kubernetes-master-02 | 192.168.1.101 | Master | CentOS Server 7.7 | 2核2G    | 80G  |
| kubernetes-master-03 | 192.168.1.101 | Master | CentOS Server 7.7 | 2核2G    | 80G  |
| kubernetes-node-01   | 192.168.1.110 | Node   | CentOS Server 7.7 | 2核4G    | 80G  |
| kubernetes-node-02   | 192.168.1.111 | Node   | CentOS Server 7.7 | 2核4G    | 80G  |
| kubernetes-node-03   | 192.168.1.120 | Node   | CentOS Server 7.7 | 2核4G    | 80G  |
| Kubernetes VIP       | 192.168.1.200 | -      | -                 | -        | -    |

## 对操作系配置

> 特别注意：以下步骤请在制作 VMware 镜像时一并完成，避免逐台安装的痛苦

#### 关闭交换空间

```bash
swapoff -a
```

#### 免开机启动交换空间

```bash
# 注释 swap 开头的行
vi /etc/fstab
```

#### 关闭防火墙

```bash
# 关闭防火墙
systemctl stop firewalld.service

# 关闭开机启动
systemctl disable firewalld.service

# 查询防火墙状态
firewall-cmd --state
```

#### 配置固定IP

```bash
# 修改为固定 ip
vi /etc/sysconfig/network-scripts/ifcfg-enp0s3

BOOTPROTO="static"         # 使用静态IP地址，默认为dhcp
IPADDR="192.168.1.xxx"     # 设置的静态IP地址
NETMASK="255.255.255.0"    # 子网掩码
GATEWAY="192.168.1.1"      # 网关地址
DNS1="192.168.1.1"         # DNS服务器
ONBOOT="yes"               # 是否开机启用

# 重启服务
service network restart
```

#### 安装 Docker

```bash
# 卸载旧版本
sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
                  
# 1. 安装必要的一些系统工具
sudo yum install -y yum-utils device-mapper-persistent-data lvm2
# 2. 添加软件源信息
sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# 3. 更新并安装Docker-CE
sudo yum makecache fast
sudo yum -y install docker-ce
# 4. 开启Docker服务和设置开机启动
sudo systemctl start docker
sudo systemctl enable docker
```

### 配置 Docker 加速器

> 特别注意：国内镜像加速器可能会很卡，请替换成你自己阿里云镜像加速器，地址如：`https://3ogo1qyx.mirror.aliyuncs.com`，在阿里云控制台的 **容器镜像服务 -> 镜像加速器** 菜单中可以找到

在 `/etc/docker/daemon.json` 中写入如下内容（如果文件不存在请新建该文件）

```json
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://3ogo1qyx.mirror.aliyuncs.com"]
}
EOF
```

#### 安装 kubeadm，kubelet，kubectl

```bash
# 证书安装
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

# 安装 kubeadm，kubelet，kubectl
yum install kubectl kubelet kubeadm

systemctl enable kubelet
```